# 3.1 数据链路层概述

- 数据链路层在网络体系中所处的地位

  - **链路(Link)** 就是从一个结点到相邻节点的一段物理线路, 而中间没有任何其他的交换节点.
  - **数据链路(Data Link)** 是指把实现通信协议的硬件和软件加到链路上, 就构成了数据链路.
  - 数据链路层以**帧**为单位传输和处理数据

  <img src="../img/截屏2020-10-22 下午8.04.04.png"  width="800"  height = "350" />



- 数据链路层的三个重要问题 : **封装成帧,差错检测,可靠传输**

  - 封装成帧 : 给网络层交付的协议数据单元添加帧头和帧尾的操作,称为封装成帧,为了以帧为单元在链路上传数据

    <img src="../img/截屏2020-10-22 下午8.14.39.png"  width="800"  height = "250" />

  - 差错检测 : 接收方通过检错码和检错算法就可以知道这个帧有没有误码

    <img src="../img/截屏2020-10-22 下午8.20.08.png"  width="800"  height = "200" />

    

  - 可靠传输 : 接收方收到有误码的帧后是不会接收该帧的,将其**丢弃**,如果数据链路层向上层提供的是**不可靠服务**,那么**丢弃就丢弃了**,没有更多措施. 若向其上层提供**可靠服务**,那么还需要其他措施使接收可以**重新收到**这个被丢弃帧的**正确副本**	---->  **尽管误码是不能完全避免的, 但若能实现发送方发送什么,接收方就能收到什么, 就称为可靠传输**

    

- 使用**广播信道**的数据链路层(共享式局域网)

  - 发送方如何判断发送给哪个主机, 接收的主机又是如何知道接收方是他?

  ​		封装成帧的头部有两个字段是与地址相关

  <img src="../img/截屏2020-10-22 下午8.37.08.png"  width="800"  height = "300" />

  - 当**总线**上多台主机同时使用总线来传输帧时, 传输信号就会产生碰撞,(这是采用广播式信道的共享式局域网不可避免的) ,解决方法 : 使用协议 -> **共享式以太网**的媒体接控制协议 **CSMA/CD**  **载波监听多点接入/碰撞检测**

    

    <img src="../img/截屏2020-10-22 下午8.47.28.png"  width="800"  height = "150" />

    

- 交换式局域网

  随着技术的发展, **交换式局域网**在**有线(局域网)领域**已完全取代了**共享式局域网**(交换及如何转发帧的? 网桥和交换机**工作原理?**)

  <img src="../img/截屏2020-10-22 下午8.49.05.png"  width="300"  height = "150" />

- 无线局域网    (由于**无线局域网**的广播天性,使用的是**共享信道技术**)

  **802.11局域网**的媒体接入控制协议**CSMA/CA 载波监听多点接入/碰撞避免**(工作原理?)

  

> 小结 : **总线共享式**广播信道用CSMA/CD, 在**有线领域**已经被取代为交换式, **无线局域网**是天然广播特性的,要使用共享信道技术使用CSMA/CA 







#  3.1 封装成帧

- ### 封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧

  - 帧头和帧尾中包含有重要的**控制信息**
  - 帧头和帧尾的作用之一就是**帧定界**

<img src="../img/截屏2020-10-22 下午9.16.55.png"  width="700"  height = "300" />

- ->发送方的数据链路层将上层交付下来的**协议数据单元**封装成帧后, 还要通过**物理层**将构成帧的各比特转换成电信号发送到传输媒体

  -> **接收方**的数据链路层如何从物理层交付的比特流中提取出一个个的帧?

  <img src="../img/截屏2020-10-22 下午9.29.05.png"  width="700"  height = "100" />

  

  - 1. ppp帧是通过**帧定界标志**来提取一个个的帧的 :

  <img src="../img/截屏2020-10-22 下午9.30.04.png"  width="700"  height = "300" />

  - 2. 并不是所有格式的帧都有帧定界标志: 以太网封装好MAC帧后交给物理层,**物理层添加一个前导码**, 前导码的前7个字节用于时钟同步,之后的一字节为开始定界符,表明其后面就是MAC帧.

  <img src="../img/截屏2020-10-22 下午9.32.21.png"  width="700"  height = "300" />

  ​			  另外, 以太网还规定了帧间间隔时间为96比特的发送时间, 因此MAC帧不需要帧结束定界符

  <img src="../img/截屏2020-10-22 下午9.38.18.png"  width="700"  height = "100" />

  ​				(帧间间隔还有其他作用,后面介绍)

- ### 透明传输

  - 透明传输是指数据链路层对**上层交付的传输数据**没有任何限制, 就好像数据链路层不存在一样

    - 面向**字节**的物理链路使用字节填充(或称字符填充)的方法实现透明传输

      要是传输的数据中包含**帧尾**怎么办?在发送帧之前, 对帧的数据部分进行扫描,每出现一个帧定界符,就在**前面加转义字符**

      <img src="../img/截屏2020-10-23 上午10.16.31.png"  width="700"  height = "200" />

      要是数据部分出现**帧定界符**怎么办?同样,发送前扫描,遇见帧定界符或转义字符,在前面添加转义字符

      <img src="../img/截屏2020-10-23 上午10.19.56.png"  width="700"  height = "200" />

      (转义字符是特殊的控制字符,长度为1字节,十进制值为27,并不是ESC这三个字母本身)

    - 面向**比特**的物理链路使用比特填充的方法实现透明传输

      比如,下图是某个点对点协议的帧, 帧的数据部分出现了两个帧定界标志,发送前使用0比特填充法, 对数据部分进行扫描, 每五个比特1后面就差入一个比特0

      <img src="../img/截屏2020-10-23 上午10.29.49.png"  width="700"  height = "200" />

      > [2013年 题37]] HDLC协议对01111100 01111110 组帧后对应的比特串为 
      >
      > A．01111100  00111110 10		 B．01111100 01111101 01111110 
      >
      > C．01111100 01111101 0 		   D．01111100 01111110 01111101 
      >
      > 【答案】A 
      >
      > 【解析】 本题考查HDLC协议中有关帧结构和实现“透明传输”的“零比特填充法”的相关知识。
      >
      > 

  - 为了提高帧的传输效率, 应当使帧的**数据部分的长度尽可能大些**

  - 考虑到差错控制等多种因素,每一种数据链路层协议都规定了帧的数据部分长度上限, 即最大传送单元**MTU**(Maximum Transfer Unit) 



# 3.3 差错检测

- 实际的通信链路都不是理想的, 比特在传输过程中可能会产生差错 : 1可能变成0, 而0可能变成1, 这称为**比特差错**.

- 在一段时间内, 传输错误占所传输比特总数的比特率称为误码率BER(Bit Error Rate)

- 使用**差错检测码**来来检测数据在传输过程中是否产生了比特差错, 是数据链路层所要解决的重要问题之一

  <img src="../img/截屏2020-10-23 上午11.17.09.png"  width="700"  height = "200" />

  - 奇偶校验

    在待发送的数据后面**添加1位奇偶校验位**,使**整个数据**(包括所添加的校验位在内)中“1”的个数为奇数(奇校验)或偶数(偶校验). 

    如果有奇数个位发生误码, 则奇偶性发生变化, 可以检查出误码.

    如果有偶数个位发生误码, 则奇偶性不会发生变化, 不能检查出误码(漏检)

    <img src="../img/截屏2020-10-23 上午11.25.40.png"  width="700"  height = "200" />

    

  - 循环冗余校验CRC(Cyclic Redundancy Check)

    - 收发双方约定好一个**生成多项式G(x)**
    - 发送方基于带发送的数据 和 生成多项式计算出差错检测码(**冗余项**),将其添加到带传输数据的后面一起传输
    - 接收方通过生成多项式来计算收到的数据是否产生了误码

    <img src="../img/截屏2020-10-23 上午11.36.15.png"  width="700"  height = "250" />

    

    <img src="../img/截屏2020-10-23 上午11.40.34.png"  width="700"  height = "250" />

    > [练习]
    >
    > 构造被除数
    >
    > <img src="../img/截屏2020-10-23 上午11.45.24.png"  width="850"  height = "120" />
    >
    > 构造除数
    >
    > <img src="../img/截屏2020-10-23 上午11.48.17.png"  width="850"  height = "200" />
    >
    > 计算步骤
    >
    > <img src="../img/截屏2020-10-23 上午11.52.26.png"  width="850"  height = "350" />

    

    > [练习]
    >
    > <img src="../img/截屏2020-10-23 下午12.03.28.png"  width="850"  height = "40" />
    >
    > <img src="../img/截屏2020-10-23 下午12.04.46.png"  width="250"  height = "250" />

    

    - **检错码**只能检测出帧在传输过程中出现了差错, 但并不能定位错误, 因此**无法纠正错误**
    - 要想纠正传输中的差错, 可以使用**冗余信息更多的纠错码**进行**向前纠错**, 但纠错码的开销比较大, 在计算机网络中**较少使用**
    - 循环冗余校验CRC有很好的检错能力(漏检率非常低就), 虽然计算比较复杂,但非常易于用硬件实现,因此被广泛应用于数据链路层
    - 常用**检错重传**方式来纠正传输中的差错, 或者仅仅是**丢弃**检测到差错的帧,取决于数据链路层向上层提供的是**可靠传输还是不可靠传输服务**



# 3.4.1 可靠传输的基本概念

- 使用差错检测技术(如循环冗余检验CRC), 接收方的数据链路层就可以检测出帧在传输过程中是否产生了误码
- 数据链路层向上层提供的服务类型
  - **不可靠传输**服务: 仅仅丢弃有误码的帧, 其他什么也不做
  - **可靠传输**服务 : 想办法实现发送端发送什么, 接收端就收到什么

- 一般情况下, **有线链路**的误码率比较低, 为了减小开销, 并**不要求数据链路层**向上层提供可靠传输服务, 即使出现了误码, 可靠传输的问题由其上层处理

- **无线链路**易受干扰, 误码率比较高,因此**要求数据链路层**必须向上层提供**可靠**传输服务

  <img src="../img/截屏2020-10-23 下午12.31.48.png"  width="750"  height = "150" />

- 比特差错只是传输差错中的一种

- 从整个计算机网络体系结构来看, 传输差错还包括**分组丢失**、分组失序以及**分组重复**

- **分组丢失**、分组失序以及**分组重复**这些传输差错, 一般不会出现在数据链路层, 而会出现在其上层

- 可靠传输服务并不仅局限于数据链路层, 其他**各层**均可选择实现可靠传输

  <img src="../img/截屏2020-10-23 下午12.36.42.png"  width="750"  height = "150" />

- 可靠传输的实现比较复杂, 开销也比较大, 是否使用可靠传输取决于应用需求

# 三种可靠传输的实现机制

这三种可靠传输实现机制的基本原理并不仅限于数据链路层, 可以应用到计算机网络体系结构的各层协议中

要放眼于整个网络体系结构

- **停止等待协议SW** 

- **回退N帧协议GBN**

- **选择重传协议SR**

## 3.4.2 可靠传输的实现机制 - 停止等待协议SW(Stop-and-Wait)

收发双方基于互联网进行通信, 而不是局限在一条点对点的数据链路

- 情况1 : ( 理想情况 ) 接收方发送确认分组 或 否认分组,

  <img src="../img/截屏2020-10-23 下午4.52.57.png"  width="200"  height = "300" />

- 情况2 : 发送方丢失发送的分组

  <img src="../img/截屏2020-10-24 上午9.14.53.png"  width="550"  height = "300" />

- 情况3 : 接收方丢失确认分组

  <img src="../img/截屏2020-10-24 上午9.21.59副本.png"  width="350"  height = "250" />

- 情况4 : 

  <img src="../img/截屏2020-10-24 上午9.33.51.png"  width="220"  height = "300" />

  

   	数据链路层点对点的往返时间比较确定, 重传时间比较好设定

  ​	 然而在运输层, 由于端到端往返时间非常不确定, 设置适合的重传时间有时并不容易

- 停止-等待协议的信道利用率

  - 当往返时延RTT远大于数据帧发送时延$T_d$时(例如使用卫星链路), 信道利用率非常低
  - 若出现重传, 则对于传送有用的数据信息来说, 信道利用率还要降低
  - 为了克服停止-等待协议信道利用率很低的缺点, 就产生了另外两种协议, 即后退N帧协议GBN 和 选择重传协议SR

  <img src="../img/截屏2020-10-24 上午9.42.26.png"  width="750"  height = "250" />



> [2018年 题 36]]  主机甲采用停-等协议向主机乙发送数据，数据传输速率是3kbps，单向传播延时是200ms，忽略确认帧的传输延时。当信道利用率等于40%时，数据帧的长度为 
>
> A．240比特 B．400比特 C．480比特 D．800比特 
>
> 【答案】D 
>
> 【解析】 根据题意，可画出下图， 
>
> <img src="../img/截屏2020-10-24 上午9.50.37.png"  width="750"  height = "200" />
>
> 信道利用率 = a ÷ (a + b + c) = 40% 设数据帧长度为x比特，$则信道利用率 = \frac{(xb ÷ 3kb/s) }{ (xb ÷ 3kb/s) + 200ms + 200ms)} = 40%$，解得 x = 800比特，因此选项D正确。





## 3.4.3 可靠传输的实现机制 - 回退N帧协议GBN

由于停止等待协议信道利用率低, 所以采用流水线方式可以提高, 回退N帧GBN是一种改进型的流水线协议

<img src="../img/截屏2020-10-24 上午10.06.51.png"  width="750"  height = "250" />

- 定义 : 

<img src="../img/截屏2020-10-24 上午10.09.16.png"  width="750"  height = "300" />

- **情况1** : 无差错情况

  ​		发送方发送发送窗口中的数据

  <img src="../img/截屏2020-10-24 上午10.11.45.png"  width="750"  height = "200" />

  

  ​			接收方每收到一个分组,就收窗口向前滑动,

  <img src="../img/截屏2020-10-24 上午10.33.43.png"  width="750"  height = "200" />

  

  ​			发送方每收到一个确认分组, 窗口就向前滑动一个

  <img src="../img/截屏2020-10-24 上午10.36.17.png"  width="750"  height = "150" />

  

  - 累积确认 : 接收方不一定要对收到书数据分组**逐个发送确认**, 可以在收到集合数据分组后, 对按序到达的最后一个数据分组发送确认. ACKn表示**序号为n以及以前的所有数据分组**都已正确接收

    <img src="../img/截屏2020-10-24 上午10.47.15.png"  width="250"  height = "150" />

    <img src="../img/截屏2020-10-24 上午10.47.23.png"  width="250"  height = "150" />

     假设ACK1在回传过程中丢失了, ACK4到达接收方也可以确认前5个分组都到达了.

<img src="../img/截屏2020-10-24 上午10.51.13.png"  width="450"  height = "150" />

​		优点 : 即使确认分组丢失, 发送方也可能不必重传, 也可以减小接收方的开销, 减少对网络资源的占用

​		缺点 : 不能向发送方及时反映出, 接收方已经正确接收的数据分组信息



- **情况2** : 有差错情况

  ​				   发送方发送发送窗口中的数据, 但在传输过程中出现了误码

  <img src="../img/截屏2020-10-24 上午11.06.10.png"  width="650"  height = "150" />

  

  ​					接收方通过校验码知道了错误, 丢弃该分组, 后续到达的四个分组与接受窗口序号不匹配, 同样不接受并丢					弃, 然后对**之前**按序接收的**最后一个分组**进行确认(ACK4) , 每丢弃一个分组, 就发送一个ACK4

  <img src="../img/截屏2020-10-24 上午11.08.07.png"  width="650"  height = "150" />

  <img src="../img/截屏2020-10-24 上午11.10.56.png"  width="650"  height = "150" />

  <img src="../img/截屏2020-10-24 上午11.17.00.png"  width="650"  height = "150" />

  ​					接收方收到过ACK4, 再收到重复的ACK4就知道传输产生了错误要重传

  <img src="../img/截屏2020-10-24 上午11.18.49.png"  width="650"  height = "150" />

  ​					其他分组被误码的组牵连, 要全部重传 -> 回退N帧

  <img src="../img/截屏2020-10-24 上午11.20.25.png"  width="650"  height = "150" />

  ​			当通信线路质量不好时, 回退N帧协议的信道利用率并比不上停止-等待协议高. 

  - 情况3:

    <img src="../img/截屏2020-10-24 上午11.24.50.png"  width="650"  height = "250" />

    > [2009年 题35] 数据链路层采用后退N 帧（GBN）协议，发送方已经发送了编号为0~7的帧。当计时器超时时，若发送方只收到0、2、3号帧的确认，则发送方需要重发的帧数是
    >
    >  A．2		 B．3		 C．4		 D．5 
    >
    > 【答案】C 
    >
    > 【解析】 根据GBN协议的特点，接收方只对按序到达且正确（无误码）的帧发送确认帧。题中所述发送方已经发送了编号为0~7的帧，但在重传计时器超时时只收到接收方针对0、2、3号帧的确认，这表明接收方已经收到按序到达且正确的编号为0~3的帧，并针对0~3号帧给发送方依次发回了确认。发送方只收到0、2、3号帧的确认，只能表明针对1号帧的确认丢失了，但这并不会引起发送方对1号帧的超时重传，因为收到3号帧的确认就足以说明接收方正确接收了0~3号帧；但编号为4的帧可能未按序到达接收方，也可能丢失，还可能出现误码，因此接收方不会针对4号帧给发送方发回确认，这将导致发送方对4号帧的超时重传，而4号帧后续的已发送的5~7号帧不管是否到达接收方，都会被发送方重传，也就是发送方会**重传4~7号帧**，选项C正确。
    >
    > <img src="../img/截屏2020-10-24 上午11.32.11.png"  width="550"  height = "100" />
    >
    > 

  ​			

  ## 3.4.4 可靠传输的实现机制 - 选择重传协议 

  - 回退N帧协议的接收窗口尺寸**$W_r$只能等于1**,  因此接收方只能按序接收正确到达的数据分组.

  - 一个数据分组误码会牵连其他分组重传,资源浪费

    

  - 设法只重传出现误码的数据分组 : **$W_r$尺寸应该大于1**, 接收方先收下失序到达(无误码)且落在接受窗口内的数据分组, 等缺失分组收齐后再一并交给山层, 这就是**选择重传协议**

    [注意] 选择重传协议为了让发送方仅重传出现差错的分组, **接收方不能采用累积确认**, 而需要对每个正确接收到的数据分组进行逐一确认




定义 : 

<img src="../img/截屏2020-10-24 下午2.02.32.png"  width="550"  height = "200" />

  

  

