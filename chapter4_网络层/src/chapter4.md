



#  4.1网络层概述

- 网络层的主要任务是**实现网络互联**, 进而**实现数据包在各网络之间的传输**

  <img src="../img/截屏2020-11-03 下午9.43.26.png"  width="500"  height = "250" />

- 要实现网络层任务, 需要解决以下主要问题:

  - 网络层向运输层提供怎样的服务(“可靠传输”还是“不可靠传输”)

  - 网络层寻址问题

    <img src="../img/截屏2020-11-03 下午9.46.29.png"  width="500"  height = "250" />

  - 路由选择问题

    <img src="../img/截屏2020-11-03 下午9.47.50.png"  width="500"  height = "250" />

    <img src="../img/截屏2020-11-03 下午9.50.12.png"  width="500"  height = "250" />

    

- **因特网(Internet)**是目前全世界用户数量最多的互联网, 它使用TCP/IP协议栈

- 由于TCP/IP协议栈的网络层使用**网际协议IP,** 它是整个协议栈的核心协议, 因此在TCP/IP协议栈中网络层常称为**网际层**

- 综上所述, 我们**通过学习TCP/IP协议栈**的网际层来学习网络层的理论知识和实践技术

  <img src="../img/截屏2020-11-04 下午2.54.57.png"  width="500"  height = "250" />

  







# 4.2 网络层提供的两种服务

### 面向连接的虚电路服务

- 必须建立网络层的连接 - **虚电路VC( Virtual Circuit )**

- 通信双方**沿着已建立的虚电路发送分组**

- 目的主机的**地址**仅在连接**建立阶段使用**, 之后每个分组的首部只需携带一条虚电路的**编号**(构成虚电路的每一段链路都有一个虚电路编号)

- 这种通信方式如果再使用可靠传输的网络协议, 就可使所发送的分组最终正确到达接收方( 无差错按序到达、不丢失、不重复 )

- 通信结束后, **需要释放之前所建立的虚电路**.

- 很多广域分组交换网都使用面向连接的虚电路服务. 例如, 曾经的X.25和逐渐过时的帧中继FR、异步传输模式ATM等.

  <img src="../img/截屏2020-11-04 下午3.21.38.png"  width="600"  height = "250" />

### 无连接的数据报服务

- **可靠通信**应当由用户主机来保证

- **不需要建立网络层连接**

- 每个分组可走不同的路径

- 每个分组的首部必须携带目的主机的完整地址

- 这种通信方式所传送的分组**可能误码、丢失、重复和失序**

- 由于网络本身不提供端到端的可靠传输服务, 这就使网络中的路由器可以做得比较简单, 而且价格低廉(与电信网的交换机相比较 )

- 因特网采用了这种设计思想, 也就是**将复杂的网络处理功能置于因特网的边缘**(用户主机和其内部的运输层), 而将相对**简单的**尽最大努力的分组交付功能**置于因特网核心**

  <img src="../img/截屏2020-11-04 下午3.38.34.png"  width="600"  height = "250" />



# 4.3.1 IPv4地址概述

- 在TCP/IP体系中, IP地址是一个最基本的概念, 我们必须把它弄清楚.

- **IPv4地址**就是给因特网(Internet)上的**每一台主机(或路由器)的每一个接口**分配一个在全世界范围内是**唯一的32比特的标识符**

- IP地址由**因特网名字和数字分配机构ICANN** ( Internet Computer Assigned Names and Numbers ) 

  - 我国用户可向**亚太网络信息中心APNIC**(Asia Pacific NetWork Information Center) 申请IP地址, 需要缴费

  - 2011年2月3日, 互联网**号码分配管理局IANA**(由ICANN行使职能) 宣布, IPv4地址已经分配完毕.

  - 我国在2014至2015年也逐步停止了向新用户和应用分配IPv4地址, 同时全面开展商用部署IPv6.

  - IPv4地址的编址方法经历了如下三个历史阶段:

    - 1981分类编址	->  1985划分子网	-> 1933无分类编址



<img src="../img/截屏2020-11-04 下午4.08.35.png"  width="750"  height = "400" />

>  [基础计算]
>
> 8421法:
>
> <img src="../img/截屏2020-11-04 下午4.12.56.png"  width="750"  height = "400" />
>
> 除2取余法:
>
> <img src="../img/截屏2020-11-04 下午4.15.13.png"  width="750"  height = "400" />









# 4.3.2 分类编址的IPv4地址(发展第一阶段)



<img src="../img/截屏2020-11-04 下午4.29.49.png"  width="750"  height = "400" />

​			最高几位固定为0或者10 、110等



### A类地址 :

<img src="../img/截屏2020-11-04 下午4.38.27.png"  width="750"  height = "400" />

### B类地址 : 

<img src="../img/截屏2020-11-04 下午4.41.57.png"  width="750"  height = "400" />

### C类地址 :

<img src="../img/截屏2020-11-04 下午5.08.55.png"  width="750"  height = "400" />



>  <img src="../img/截屏2020-11-04 下午5.21.47.png"  width="750"  height = "400" />     





> [考研2017年 题36] 下列IP地址中，只能作为IP分组的源IP地址但不能作为目的IP地址的是
>
>  A．0.0.0.0		 B．127.0.0.1 		C．20.10.10.3 		D．255.255.255.255 
>
> 【答案】A 
>
> 【解析】 
>
> **地址0.0.0.0**是一个特殊的IP地址，只能作为源地址使用，**表示“在本网络上的本主机”**。封装有DHCP Discovery报文的IP分组的源地址使用0.0.0.0。 
>
> **以127开头**且后面三个字节非“全0”或“全1”的IP地址是一类特殊的IP地址，**既可以作为源地址使用，也可以作为目的地址使用**，用于本地软件环回测试，例如常用的环回测试地址127.0.0.1。 
>
> **地址255.255.255.255是一个特殊的IP地址**，只能作为**目的地址**使用，表示“只在本网络上进行广播（各路由器均不转发）”。 综上所述，选项A正确。
>
> <img src="../img/截屏2020-11-04 下午5.25.57.png"  width="750"  height = "250" />



> <img src="../img/截屏2020-11-04 下午5.30.07.png"  width="750"  height = "400" />











# 4.3.3 划分子网的IPv4地址(发展第二阶段)

![截屏2020-11-10 下午9.30.47](../img/%E6%88%AA%E5%B1%8F2020-11-10%20%E4%B8%8B%E5%8D%889.30.47.png)

这个公司申请C类ip, 产生了大量的剩余, 随着公司规模的扩大, 需要将公司的网络划分出三部分, 可以借用主机号的前八位作为子网号

- 32比特的子网掩码可以表明分类IP地址的主机号部分**被借用了几个比特**作为子网号

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-10%20%E4%B8%8B%E5%8D%889.37.16.png" alt="截屏2020-11-10 下午9.37.16" style="zoom:40%;" />

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-10%20%E4%B8%8B%E5%8D%889.38.14.png" alt="截屏2020-11-10 下午9.38.14" style="zoom:50%;" />

  - 子网掩码使用**连续的比特1**来对应网络号和子网号
  - 子网掩码使用**连续的比特0**来对应主机号
  - 将划分子网的IPv4地址与其相应的子网掩码进行**逻辑与运算**就可以得到IPv4地址所在**子网的网络地址**

- 具体子网划分细节:

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-13%20%E4%B8%8B%E5%8D%881.01.12.png" alt="截屏2020-11-13 下午1.01.12" style="zoom:40%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-13%20%E4%B8%8B%E5%8D%884.47.40.png" alt="截屏2020-11-13 下午4.47.40" style="zoom:50%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-13%20%E4%B8%8B%E5%8D%884.48.21.png" alt="截屏2020-11-13 下午4.48.21" style="zoom:50%;" />

> [考研2012年 题39]某主机的IP地址为180.80.77.55，子网掩码为255.255.252.0。若该主机向其所在子网发送广播分组，则目的地址可以是 
>
> A．180.80.76.0 		B．180.80.76.255	
>
> C．180.80.77.255 	D．180.80.79.255 
>
> 【答案】D 
>
> 【解析】 将给定的子网掩码255.255.252.0转换成点分二进制形式为11111111.11111111.11111100.00000000，该子网掩码由22个连续的比特1和10个连续的比特0构成，这表明给定的主机IP地址180.80.77.55的前22个比特为网络号和子网号部分，后10个比特为主机号部分。将网络号和子网号部分保持不变，将主机号部分全部置1，就可以得到该子网的广播地址。将主机IP地址180.80.77.55中的前两个十进制数180和80保持不变，相当于IP地址的前16比特保持不变。很显然，还需要将第三个十进制数77的前6比特保持不变，将77转换成二进制数01001101，将其前6比特保持不变，后2比特置1。最后将第四个十进制数55更改为255，这相当于最后8比特全部置1。将结果转换成点分十进制形式就可以得出主机所在子网的广播地址为180.80.77.255，因此选项D正确。
>
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-13%20%E4%B8%8B%E5%8D%884.58.08.png" alt="截屏2020-11-13 下午4.58.08" style="zoom:50%;" />

默认子网掩码 : 

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-13%20%E4%B8%8B%E5%8D%885.00.00.png" alt="截屏2020-11-13 下午5.00.00" style="zoom:50%;" />



# 4.3.4 无分类编址的IPv4地址(发展第三阶段)

- 划分子网在一定程度上缓解了因特网在发展中遇到的困难, 但是**数量巨大的C类网络因为其地址空间太小**并没有得到充分使用, 而因特网的IP仍在加速消耗, 整个IPv4地址空间面临全部耗尽的威胁.

- 因此, 因特网工程任务组IETF又提出了采用**无分类编址**的方法来解决IP地址紧张的问题, 同时还专门**成立IPv6**工作组负责研究新版本IP以池底解决IP地址耗尽问题.

- 1993年, IEFTF发布了**无分类域间路由选择CIDR**(Classless Inter-Domain Routing)的RFC文档:RFC 1517~1519和1520

  - CIDR消除了传统的A类、B类和C类地址, 以及划分子网的概念;
  - CIDR可以更加有效地分配IPv4的地址空间, 并且可以在新的IPv6使用之前允许因特网的规模继续增长.

- CIDR使用**“斜线记法”**, 或称CIDR记法. 即在IPv4地址后面加上斜线“/”, **在斜线后面写上网络前缀所占的比特数量**

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.05.30.png" alt="截屏2020-11-14 下午3.05.30" style="zoom:50%;" />

- CIDR实际上是将网络前缀都相同的连续的IP地址组成一个“CIDR地址块”.

- 我们只要知道CIDR地址块中的任何一个地址, 就可以知道该地址块的全部细节:

  - 地址块的最小地址
  - 地址块的最大地址
  - 地址块中的地址数量
  - 地址块聚合某类网络(A类、B类、C类)的数量
  - 地址掩码(也可继续称为子网掩码)

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.19.40.png" alt="截屏2020-11-14 下午3.19.40" style="zoom:50%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.22.07.png" alt="截屏2020-11-14 下午3.22.07" style="zoom:50%;" />

- 路由聚合

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.25.58.png" alt="截屏2020-11-14 下午3.25.58" style="zoom:50%;" />

> [2011年 题 38]在子网192.168.4.0/30中，能接收目的地址为192.168.4.3的IP分组的最大主机数是
>
>  A．0		 B．1 		C．2 		D．4 
>
> 【答案】C
>
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.29.52.png" alt="截屏2020-11-14 下午3.29.52" style="zoom:50%;" />

> [2018年 题38] 某路由表中有转发接口相同的4条路由表项，其目的网络地址分别为35.230.32.0/21、35.230.40.0/21、35.230.48.0/21和35.230.56.0/21，将该4条路由聚合后的目的网络地址为
>
>  A．35.230.0.0/19 		B．35.230.0.0/20		 C．35.230.32.0/19 		D．35.230.32.0/20 
>
> 【答案】C 
>
> 【解析】 本题考查路由聚合技术。将多个目的网络地址聚合为一个目的网络地址的方法是“找共同前缀”。 本题的解题细节如下所示，
>
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.35.10.png" alt="截屏2020-11-14 下午3.35.10" style="zoom:50%;" />



# 4.3.5 IPv4地址的应用规划

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.44.17.png" alt="截屏2020-11-14 下午3.44.17" style="zoom:50%;" />



### - 定长的子网掩码划分子网的方法

[例] 假设申请到的C类网络为218.75.230.0, 请使用定长的子网掩码给下图所示的小型网络中的各设备分配IP地址

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.48.17.png" alt="截屏2020-11-14 下午3.48.17" style="zoom:50%;" />

[解] 首先统计一下各个网络所需的IP地址数量:

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.53.51.png" alt="截屏2020-11-14 下午3.53.51" style="zoom:50%;" />

设计要借用几个比特作为子网号可以满足需求, 子网掩码为255.255.255.224

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%884.01.10.png" alt="截屏2020-11-14 下午4.01.10" style="zoom:50%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%884.04.32.png" alt="截屏2020-11-14 下午4.04.32" style="zoom:50%;" />

↓以此类推, 写出后续的子网划分, 写出这些子网如下图

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%884.07.09.png" alt="截屏2020-11-14 下午4.07.09" style="zoom:50%;" />

任意分配就是结果了:

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%884.09.26.png" alt="截屏2020-11-14 下午4.09.26" style="zoom:50%;" />

弊端: 途中的网络N5只需要4个网络地址, 但用定长的方式分配的太多了, 导致IP地址的严重浪费



### - 变长的子网掩码VLSM

[例] 假设申请到的C类网络为218.75.230.0, 请使用定长的子网掩码给下图所示的小型网络中的各设备分配IP地址

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%883.48.17.png" alt="截屏2020-11-14 下午3.48.17" style="zoom:50%;" />

[解]首先根据各个网络, 写出最合适的主机号位数

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%884.21.10.png" alt="截屏2020-11-14 下午4.21.10" style="zoom:50%;" />

- 从地址块218.75.230.0/24中取出5个地址块:

  1个“/27”地址块, 

  3个“/28”地址块, 

  1个“/30”地址块, 

  按需分配给下图的5个网络

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%884.30.10.png" alt="截屏2020-11-14 下午4.30.10" style="zoom:50%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.17.47.png" alt="截屏2020-11-14 下午8.17.47" style="zoom:50%;" />

[习题]

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.18.27.png" alt="截屏2020-11-14 下午8.18.27" style="zoom:50%;" />





# 4.4 IP数据报的发送和转发过程

- IP数据报的发送和转发过程包含以下两个部分:

  - 主机发送IP数据报

  - 路由器转发IP数据报

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.25.57.png" alt="截屏2020-11-14 下午8.25.57" style="zoom:50%;" />

- 举例转发过程:

  路由器的接口0直连了一个交换式以太网, 接口1也直连了一个交换式以太网, 分配网络地址和子网掩码如下图所示

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.28.48.png" alt="截屏2020-11-14 下午8.28.48" style="zoom:50%;" />

  主机A给主机C发送数据报为直接交付

  主机C给主机F发送数据报为间接交付

  > 源主机如何知道目的主机是否与自己在同一个网络中?
  >
  > 用<u>主机号</u>与他的<u>子网掩码</u>**相与**, 就可以得到主机所在的**网络地址**

  主机C要**给主机F**发送IP数据报, 一定**知道F的地址**. 用F的地址与**C的子网掩码**相与, 就知道是否在同一个网络

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.33.51.png" alt="截屏2020-11-14 下午8.33.51" style="zoom:50%;" />

  > 主机C如何知道交给哪个路由器进行转发呢?
  >
  > 为了让本网络的主机能够与其他网络中的进行通信, 就必须给其指定本网络中的一个路由器, 由该路由器帮忙进行转发, 所指定的路由器, 也被称为默认网关

本例, 可以将路由器接口0的IP地址, 指定给该接口所**直连网络中的各个主机**作为默认网关

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.43.57.png" alt="截屏2020-11-14 下午8.43.57" style="zoom:50%;" />

> 路由器收到IP数据报后如何转发?
>
> 1. 检查IP数据报的**首部**是否出错:
>
>    若出错直接丢弃该IP数据报并通告源主机, 若没有出错, 则进行转发
>
> 2. 根据IP数据报的目的地址在路由表中查找匹配的条目:
>
>    若找到匹配的条目, 则转发给条目中指示的下一跳,
>
>    若找不到, 则丢弃该IP数据报并通告源主机

主机A要给主机D发送IP数据报, 根据默认网关找到路由器, 路由器接收该数据报, 根据路由表找到对应的网络

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.54.36.png" alt="截屏2020-11-14 下午8.54.36" style="zoom:50%;" />

关于广播的转发:

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%888.59.29.png" alt="截屏2020-11-14 下午8.59.29" style="zoom:50%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.00.22.png" alt="截屏2020-11-14 下午9.00.22" style="zoom:50%;" />

> [2010年 题38]]下列网络设备中，能够抑制广播风暴的是 Ⅰ中继器     Ⅱ 集线器     Ⅲ 网桥     Ⅳ 路由器
>
>  A．仅I和II 		B．仅III 		C．仅III和IV 		D．仅IV 
>
> 【答案】D 
>
> 【解析】 
>
> 中继器和集线器工作在物理层，既**不隔离冲突域也不隔离广播域。** 
>
> 网桥和交换机（多端口网桥）工作在数据链路层，可以根据所接收帧中目的MAC地址以及帧交换表（通过自身的自学习算法被动学来）来转发帧，这样就可以“过滤帧”而**隔离冲突域**。换句话说，使用交换机将多个独立的冲突域互连起来，可以扩大通信范围，但是并不会形成一个更大的冲突域，这些独立的冲突域互连后属于同一个局域网，也就是同一个广播域。
>
>  路由器工作在网络层，**既隔离冲突域，也隔离广播域**（试想一下，我们最常用的互联网是由多个网络和路由器互连起来的，互联网上的某个用户如果广播发送一个IP数据报，收到该广播IP数据报的路由器如果不丢弃该数据报而是转发该数据报将会出现什么情景）。





> [2012年 题37]] 下列关于IP路由器功能的描述中，正确的是 
>
> I.运行路由协议，设置路由表 
>
> II.监测到拥塞时，合理丢弃IP分组
>
>  III.对收到的IP分组头进行差错校验，确保传输的IP分组不丢失 
>
> IV.根据收到的IP分组的目的IP地址，将其转发到合适的输出线路上
>
>  A．仅III、IV 		B．仅I、II、III 		C．仅I、II、IV 		D．I、II、III、IV 
>
> 【答案】C 
>
> 【解析】
>
>  IP路由器工作在TCP/IP体系的网际层（或称IP层），TCP/IP体系的网际层并不负责可靠传输，而是“尽最大努力的交付”，这并**不能确保传输的IP分组不丢失。**
>
>  IP路由器对收到的IP分组头进行差错校验，当发现**错误时会丢弃该IP分组**并向源主机**发送ICMP差错报告报文**，具体类型为参数错误。
>
>  综上所述，题目中的描述III是错误的，利用排除法可知选项C正确。题目中的描述I，II，IV都是正确的。
>
> 



> [2015年题47]（9分）某网络拓扑如题47图所示，其中路由器内网接口、DHCP服务器、WWW服务器与主机1均采用静态IP地址配置，相关地址信息见图中标注；主机2～主机N通过DHCP服务器动态获取IP地址等配置信息。
> 	
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.10.12.png" alt="截屏2020-11-14 下午9.10.12" style="zoom:50%;" />
> 	
>
> 3)   若主机1的子网掩码和默认网关分别配置为255.255.255.0和111.123.15.2，则该主机是否能访问WWW服务器?是否能访问Internet?请说明理由。
>
>
> ​	[解]
> ​	
> ​	可以访问WWW服务器, 根据CIDR,他们两个划分在同一个网络中
> ​	
>
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.15.38.png" alt="截屏2020-11-14 下午9.15.38" style="zoom:50%;" />
> 	
>
> 不可以访问Internet, 因为网关配置错误 
> 	
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.17.10.png" alt="截屏2020-11-14 下午9.17.10" style="zoom:50%;" />





# 4.5 静态路由配置及其可能产生的路由环路问题

- 静态路由配置是指**用户或网络管理员**使用路由器的相关命令给路由器**人工配置路由器表.**
  - 人工配置简单, 开销小, 但不能及时适应网络状态(流量, 拓扑等)的变化
  - 一般只在小规模网络中采用
- 使用静态路由配置可能出现以下导致产生路由环路的错误
  - 配置错误
  - 聚合了不存在的网络
  - 网络故障



**[举例] 静态路由配置**

R1要转发给R2, 配置静态路由表, 手动添加目的网络地址192.168.2.0/24 和R1的下一跳地址(即R2接口0的地址)

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.31.59.png" alt="截屏2020-11-14 下午9.31.59" style="zoom:50%;" />

R2要转发给R1连接网络中的某个主机, 手动添加路由条目

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.41.55.png" alt="截屏2020-11-14 下午9.41.55" style="zoom:50%;" />



**[举例] 默认路由举例**

​		对于具有**相同下一跳的**不同目的网络的路由条目, 可以用一条默认路由条目来替代(配置好默认后, 甚至可以删除192.168.2.0/24这一条路由条目)

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.44.53.png" alt="截屏2020-11-14 下午9.44.53" style="zoom:50%;" />



**[举例] 特定主机路由的概念**	

​	用于网络管理人员对网络的管理和测试

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-14%20%E4%B8%8B%E5%8D%889.50.28.png" alt="截屏2020-11-14 下午9.50.28" style="zoom:50%;" />



**[举例] 静态路由配置错误导致路由环路**

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.12.36.png" alt="截屏2020-11-15 上午11.12.36" style="zoom:60%;" />

**[举例] 聚合了不存在的网络而导致路由环路问题**

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.34.29.png" alt="截屏2020-11-15 上午11.34.29" style="zoom:60%;" />

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.37.50.png" alt="截屏2020-11-15 上午11.37.50" style="zoom:60%;" />

​					看细节, 实际上该网络包含以下四个网络,

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.38.27.png" alt="截屏2020-11-15 上午11.38.27" style="zoom:50%;" />

​					R2要转发IP数据报到这个不存在的网络时, 查找R2的路由表,下一跳转发给R1的接口, **但是**对于这个不存在的					网络, 路由器R2**应不与转发**, 却错把它转发给了R1, R1查表转发, 走默认路由转发给R2的接口0, 产生环路

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.20.13.png" alt="截屏2020-11-15 上午11.20.13" style="zoom:60%;" />

​					**解决方法:** 可以添加一个黑洞路由条目, 有去无回, 丢弃IP数据报, 而不是转发IP数据报

​					假如一个IP数据报由R2**转发IP数据报到不存在的网络**, 查表有两条可选, 根据最长前缀匹配原则选择了黑洞 

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.20.53.png" alt="截屏2020-11-15 上午11.20.53" style="zoom:60%;" />

**[举例] 网络故障而导致路由环路**

​						R1会删除这个故障的路由条目, R2转发给R1的接口1, 没有找到路由条目, 走默认网络,产生环路

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.50.38.png" alt="截屏2020-11-15 上午11.50.38" style="zoom:60%;" />

​						解决方法 :

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8A%E5%8D%8811.52.39.png" alt="截屏2020-11-15 上午11.52.39" style="zoom:60%;" />

​						**若故障好了**, R1路由表又会动态的添加这个网络的路由条目, 并**将黑洞路由标记为失效状态**

​						**若又发生故障,** 则自动删除路由条目, 并将人工配置的**黑洞路由**设置为**生效状态.**

# 4.6.1 路由选择协议概述

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.00.32.png" alt="截屏2020-11-15 下午12.00.32" style="zoom:50%;" />

- 因特网所采用的路由选择协议的主要**特点**

  - 自适应 : 动态路由选择, 能较好地适应网络状态的变化

  - 分布式 : 路由器之间信息交互, 共同王成路由信息的获取和更新, 

  - **分层次 :** 将整个因特网划分为许多较小的自治系统AS(Autonomous System)

    例如, 一个较大的因特网服务提供商, 就可划分为一个自治系统, 在自治系统内部和外部采用不同的路由选择协议,分别进行路由选择

- 因特网采用**分层次**的路由选择协议

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.10.02.png" alt="截屏2020-11-15 下午12.10.02" style="zoom:50%;" />

- 常见的路由选择协议(内外网关IGP EGP是这一类的**称呼**, 并不是具体协议名称)

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.12.12.png" alt="截屏2020-11-15 下午12.12.12" style="zoom:50%;" />

- 路由器的基本结构

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.15.23.png" alt="截屏2020-11-15 下午12.15.23" style="zoom:50%;" />

  ​		还有输入输出缓冲区, 用来暂存处理完毕, 但还来不及发送的分组





# 4.6.2 路由信息协议RIP的基本工作原理

- **路由信息协议RIP**(Routing Information Protocol) 是**内部网关协议IGP**中最先得到广泛使用的协议之一, 其相关标准文档为RFC 1058

- **RIP要求**自治系统AS内部的每一个路由器都要维护**从他自己**到AS内**其他每一个网络**的距离记录, 这是一组距离, 称为“**距离向量D-V(Distance-Vector)**”

- RIP使用**跳数(Hop count)** 作为度量(Metric) 来衡量到达目的网络的距离

  - 路由器到**直连**网络的**距离定义为1**

  - 路由器到**非直连**网络的距离定义为**所经过的路由器数加1**

  - 允许一条路径最多只能包含15个路由器. **“距离”等于16**相当于不可达. 因此, RIP只适用于小型网络

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.30.16.png" alt="截屏2020-11-15 下午12.30.16" style="zoom:50%;" />

- RIP认为**好的路由就是“距离短”**的路由, 也就是所通过路由器数量最少的路由.

  - RIP认为R1到R5的好路由是: R1-> R4 ->R5 (尽管这一条链路上带宽都非常小)

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.31.43.png" alt="截屏2020-11-15 下午12.31.43" style="zoom:50%;" />

  - 当到达同一目的网络有多条“距离相等”的路由时, 可以进行**等价负载均衡**

    也就是将通信量均衡地分布到多条等价的路由上

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.36.51.png" alt="截屏2020-11-15 下午12.36.51" style="zoom:50%;" />

- RIP包含以下三个要点:

  - 和谁交换信息 仅和**相邻路由器**交换信息

  - 交换什么信息 自己的**路由表**

  - 何时交换信息 **周期性交换**(例如每30秒)

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.40.41.png" alt="截屏2020-11-15 下午12.40.41" style="zoom:50%;" />

**[举例] RIP的基本工作过程**

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%8812.43.16.png" alt="截屏2020-11-15 下午12.43.16" style="zoom:50%;" />

**[举例] RIP的路由条目的更新规则**

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%884.53.33.png" alt="截屏2020-11-15 下午4.53.33" style="zoom:50%;" />

​		注意, 如果**相同的下一跳**, 距离变长了为最新消息 -> 更新

​		 如果不同的下一跳, 距离变长了为新路由劣势 -> 不更新

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%884.58.18.png" alt="截屏2020-11-15 下午4.58.18" style="zoom:50%;" />

[练习] ![截屏2020-11-15 下午5.02.42](../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.02.42.png)

> [2010年 题35] 某自治系统内采用RIP协议，若该自治系统内的路由器R1收到其邻居路由器R2的距离矢量，距离矢量中包含信息<net1, 16>，则能得出的结论是 
>
> A．R2可以经过R1到达net1，跳数为17
>
> B．R2可以到达net1，跳数为16 
>
> C．R1可以经过R2到达net1，跳数为17
>
> D．R1不能经过R2到达net1 
>
> 【答案】D 
>
> 【解析】 本题考查路由信息协议RIP(Routing Information Protocol)的相关概念。RIP是最早得到广泛使用的内部网关协议IGP。 RIP是一种基于距离矢量D-V(Distance-Vector)算法的协议，它使用跳数(Hop Count)作为度量(Metric)来衡量到达目的网络的距离。默认情况下，路由器到与它直接相连网络的跳数为0，因此距离为0；路由器到与它非直连网络的距离等于中间所经过路由器的数量；距离的**取值范围是0~15**，等于或大于16的距离被定义为无穷大，即目的网络不可达。 在本题中，路由器R1收到其邻居路由器R2的距离矢量，距离矢量中包含信息，这就表明路由器R2无法到达目的网络net1，那么R1就不能经过R2达到net1。因此，选项D正确。



- RIP存在“**坏消息传播的慢**”的问题

  假设N1的网络发生故障, R1将N1的距离设置为16表示为不可达,然而R2的RIP协议仍然是通过先前获取到的(即到达N1的距离为2) 下一跳通过R1转发,.

  假设R2的这条信息**先**到达R1, 而R1的这条信息后到达R2 

  当R1先收到这条路由信息后, 就会被该谣言误导, 认为可以通过R2到达N1, 距离为3

  当R2收到R1的这条路由信息后, 被该谣言误导, 认为可以通过R1到达N1, 距离为4(在自己的RIP跟新周期到时后将这条信息发送给R1)

  

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.43.23.png" alt="截屏2020-11-15 下午5.43.23" style="zoom:50%;" />

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.43.31.png" alt="截屏2020-11-15 下午5.43.31" style="zoom:50%;" />

  - "坏消息传播的慢"又称为“路由环路”或“距离无穷计数”问题, 这是距离向量算法的一个固有问题.

    可以采取多种措施减少出现该问题的概率或减小该问题带来的危害

    - 限制最大路径距离为15(16表示不可达)

    - 当路由表发生变化时就立即发送更新报文(即“**触发更新**”), 而不仅是周期性发送

    - 让路由器记录**收到某特定路由信息的接口**, 而不让同一路由信息再通过此接口反向传送(即“**水平分割**”)

      > [2016年 题37] 假设R1、R2、R3采用RIP协议交换路由信息，且均已收敛。若R3检测到网络201.1.2.0/25不可达，并向R2通告一次新的距离向量，则R2更新后，其到达该网络的距离是
      >
      >  A．2 			B．3 		C．16 		D．17 
      >
      > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.55.49.png" alt="截屏2020-11-15 下午5.55.49" style="zoom:50%;" />
      >
      > 【答案】B
      >
      > 【解析】根据题目所给“若R3检测到网络201.1.2.0/25不可达”, 可知, R3与该网络是直连的
      >
      > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.56.37.png" alt="截屏2020-11-15 下午5.56.37" style="zoom:50%;" />
      >
      > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.58.45.png" alt="截屏2020-11-15 下午5.58.45" style="zoom:50%;" />
      >
      > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%885.59.49.png" alt="截屏2020-11-15 下午5.59.49" style="zoom:50%;" />
      >
      > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%886.00.23.png" alt="截屏2020-11-15 下午6.00.23" style="zoom:50%;" />
      >
      > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%886.01.00.png" alt="截屏2020-11-15 下午6.01.00" style="zoom:50%;" />
      >
      > 



# 4.6.3 开放最短路径优先OSPF的基本工作原理

- **开放最短路径优先OSPF**(Open Shortest Path First), 是为了克服RIP的缺点在1989年开发出来的.

  - “开放”表明OSPF协议不是受某一厂家控制, 而是公开发表的

  - “最短路径优先”是因为使用了Dijkstra提出的**最短路径算法SPF**

  - OSPF是**基于链路状态的**, 而不像RIP那样是基于距离向量的

  - OSPF采用SPF算法计算路由, 从算法上保证了**不会产生路由环路**

  - OSPF**不限制网络规模**, 更新效率高, **收敛速度快**

  - 链路状态是指本路由器都**和哪些路由器相邻**, 以及相应**链路的“代价”**(cost)

    - "代价" 用来表示费用、距离、时延、带宽,等等. 这些都由网络管理人员来决定

      [举例] 思科路由器中OSPF计算代价的方法: **100Mbps/链路带宽**

      ​		  计算结果小于1的值仍记为1; 大于1且有小数的, 舍去小数

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%888.17.14.png" alt="截屏2020-11-15 下午8.17.14" style="zoom:50%;" />

  - OSPF相邻路由器之间通过交互**问候(Hello)分组**, 建立和维护**邻居关系**

    - Hello分组**封装在IP数据报**中, 发往组播地址224

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%888.27.18.png" alt="截屏2020-11-15 下午8.27.18" style="zoom:50%;" />

    - 发送周期为10秒

    - 40秒未收到来自邻居路由器的Hello分组, 则认为该邻居路由器不可达

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%888.29.05.png" alt="截屏2020-11-15 下午8.29.05" style="zoom:50%;" />

      

  - 使用OSPF的每个路由器都会产生**链路状态通告LSA**(Link State Advertisement). LSA中包含以下内容

    - 直连网络的链路状态信息

    - 邻居路由器的链路状态信息

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%888.33.59.png" alt="截屏2020-11-15 下午8.33.59" style="zoom:50%;" />

  - LSA被封装在**链路状态更新分组LSU**中, 采用洪泛法发送.

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%888.38.02.png" alt="截屏2020-11-15 下午8.38.02" style="zoom:50%;" />

  - 使用OSPF的每个路由器都有一个**链路状态数据库LSDB**, 用于存储LSA

  - 通过各路由器洪泛发送封装有自己LSA的LSU分组, 各路由器的LSDB最终将达到一致.

  - 使用OSPF的各路由器基于LSDB进行最短路径优先SPF计算, 构建出各自到达其他各路由器的最短路径, 即构建各自的路由表.

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%888.44.12.png" alt="截屏2020-11-15 下午8.44.12" style="zoom:50%;" />

  - OSPF有以下五种分组类型

    - 类型1, **问候**(Hello)分组

      用来发现和维护邻居路由器的可达性

    - 类型2, **数据库描述**(Database Description) 分组

      向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息

    - 类型3, **链路状态请求**(Link State Request) 分组

      向邻居路由器请求发送某些链路状态项目的详细信息

    - 类型4, **链路状态更新**(Link State Update) 分组

      路由器使用这种分组将其链路状态进行洪泛发送, 即用洪泛法对全网更新链路状态.

    - 类型5, **链路状态确认**(Link State Acknowledgment)分组

      这是对链路状态更新分组的确认分组.

      

  - OSPF的基本工作过程

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.03.54.png" alt="截屏2020-11-15 下午9.03.54" style="zoom:50%;" />

  - OSPF在多点接入网络中路由器邻居关系的建立

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.11.49.png" alt="截屏2020-11-15 下午9.11.49" style="zoom:50%;" />

    - 选举**指定路由器**DR(designated router)和**备用的指定路由器BDR**(backup designated router)

    - 所有的非DR/BDR只与DR/BDR建立邻居关系

    - 非DR/BDR之间通过DR/BDR交换信息

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.19.38.png" alt="截屏2020-11-15 下午9.19.38" style="zoom:50%;" />

    

  - <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.24.44.png" alt="截屏2020-11-15 下午9.24.44" style="zoom:50%;" />

    

# 4.6.4 边界网关协议BGP的基本工作原理

- 因特网采用分层次的路由选择协议

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.38.29.png" alt="截屏2020-11-15 下午9.38.29" style="zoom:50%;" />

- **内部网关协议IGP**(例如路由信息协议RIP 或 开放最短路径优先OSPF)

    - 设法使分组在一个自治系统内经可能有效地从源网络传输到目的网络
    - 无需考虑自治系统外部其他方面的策略
    
- **外部网关协议EGP**(例如边界网关协议BGP)

    - 在**不同自治系统内**, 度量路由的“代价” (距离, 带宽, 费用等) 可能不同.

      因此, 对于**自治系统之间的路由选择**, 使用“代价”作为度量来寻找最佳路由是不行的.

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.46.40.png" alt="截屏2020-11-15 下午9.46.40" style="zoom:50%;" />

    - 自治系统之间的路由选择必须考虑相关策略(政治, 经济, 安全等)

    - BGP只能是力求寻找一条能够到达目的网络且比较好的路由(不能兜圈子) 

      而并非要寻找一条最佳路由

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-15%20%E4%B8%8B%E5%8D%889.50.41.png" alt="截屏2020-11-15 下午9.50.41" style="zoom:50%;" />

      

      

    - 在配置BGP时, 每个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP发言人”

    - 不同自治系统的BGP发言人要交换路由信息, **首先必须建立TCP连接**, **端口号为179**

      - 在此TCP连接上交换BGP报文以建立BGP会话
      - 利用BGP会话交换路由信息(例如, 增加新的路由, 或撤销过时的路由, 以及报告出错的情况等)
      - 使用TCP连接交换路由信息的两个BGP发言人, 彼此称为对方的邻站(neighbor)或对等站(peer)

    - BGP发言人除了运行BGP外, 还必须运行自己所在自治系统所使用的**内部网关协议**IGP, 例如OSPF或RIP

    - BGP发言人**交换网络可达性的信息**(要到达某个网络所要经过的一系列自治系统)

    - 当BGP发言人互相交换了网络可达性信息后, 各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各自治系统的较好的路由, 也就是构造出树形结构, 不存在回路的自治系统连通图(右图为自治系统AS1的某个BGP发言人构造出的自治系统连通图)

      ![截屏2020-11-16 下午2.03.39](../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%882.03.39.png)

  ​    

- BGP适用于多级结构的因特网

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%882.06.36.png" alt="截屏2020-11-16 下午2.06.36" style="zoom:50%;" />

- BGP-4有以下四种报文

  - **OPEN(打开)报文** : 用来与相邻的另一个BGP发言人建立关系, 使通信初始化
  - **UPDATE(更新报文)** : 用来通告某一路由的信息, 以及列出要撤销的多条路由
  - **KEEPALIVE(保活)报文** : 用来周期性地证实邻站的连通性
  - **NOTIFIVCATION(通知)报文**: 用来发送检测到的差错



> [2013年 47.（9 分）]假设Internet的两个自治系统构成的网络如题47图所示，自治系统AS1由路由器R1 连接两个子网构成；自治系统AS2由路由器R2、R3互联并连接3个子网构成。各子网地址、R2的接口名、R1与R3的部分接口IP地址如题47图所示。
>
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%882.18.21.png" alt="截屏2020-11-16 下午2.18.21" style="zoom:50%;" />
>
> 3)  R1与R2之间利用哪个路由协议交换路由信息？该路由协议的报文被封装到哪个协议的分组中进行传输？
>
> 
>
> [解]
>
> R1和R2分处于两个不同的自治系统AS，
>
> AS之间的路由选择协议属于外部网关协议EGP这个类型，典型的协议为**边界网关协议BGP**，目前使用最多的版本是BGP-4；
>
> BGP-4报文被封装在**TCP报文段**中进行传输。



> [2017年 题 37 ]直接封装RIP、OSPF、BGP报文的协议分别是
>
>  A．TCP、UDP、IP		 B．TCP、IP、UDP		 C．UDP、TCP、IP		 D．UDP、IP、TCP 
>
> 【答案】D 
>
> 【解析】 本题没有什么解题技巧，主要考察三种典型的路由协议报文应该使用何种协议封装，属于需要归类记忆的内容。 RIP报文使用UDP用户数据报进行封装。 OSPF报文使用IP数据报进行封装。 BGP报文使用TCP报文段进行封装。 综上所述，选项D正确。
>
> <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%882.24.43.png" alt="截屏2020-11-16 下午2.24.43" style="zoom:50%;" />



# 4.7 IPv4数据报的首部格式

<img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%883.00.57.png" alt="截屏2020-11-16 下午3.00.57" style="zoom:70%;" />

-  版本 : 

  占4比特, 表示IP协议的版本

  通信双方使用的IP协议版本必须一致. 目前广泛使用的IP协议版本号为4 (即IPv4)
  
- **首部长度 :** 

  占4比特, 表示IP数据报首部的长度. 该字段的取值***以4字节***为**单位**

  最小十进制取值为5, 表示IP数据报首部只有20字节固定部分

  最大十进制取值为15, 表示IP数据报首部包含20字节固定部分和最大40字节可变部分

-  可选字段 :

   长度从1个字节到40个字节不等, 用来**支持排错、测量及安全等措施**.

   可选字段增加了IP数据报的功能, 但这同时也使得IP数据报的首部长度称为可变的.这就增加了每一个路由器处理IP数据报的开销. 实际上可选字段很少被使用

-  填充字段 : 

   确保**首部长度**为4字节的整数倍, 使用全0进行填充

-  区分服务 : 

   占8比特, 用来获得更好的服务.

   该字段在旧标准中叫作**服务类型**, 但实际上一直没有被使用过. 1998年, 因特网工程任务组IETF吧这个字段改名为**区分服务**, 利用该字段的不同数值可提供不同等级的服务质量. 只有在使用区分服务时, 该字段才起作用, 一般情况下都不使用该字段

-  **总长度 :** 

   占16比特, 表示IP数据报的总长度( 首部 + 数据载荷 )

   最大取值为十进制65535, ***以字节***为单位.

   > **[举例]** 首部长度 和 总长度的区别与联系
   >
   > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%884.41.23.png" alt="截屏2020-11-16 下午4.41.23" style="zoom:50%;" />
   >
   > ​					首部长度 = 二进制取值转化为十进制 **x 4** (乘4的原因是他以四字节为单位)
   >
   > ​						总长度 = 二进制取值转化为十进制
   >
   > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%884.42.16.png" alt="截屏2020-11-16 下午4.42.16" style="zoom:50%;" />
   >
   > 

   

- **标识、标志、片偏移 :** 

  这三个字段共同用于IP数据报分片, 片偏移以***8字节***为单位

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%884.58.33.png" alt="截屏2020-11-16 下午4.58.33" style="zoom:50%;" />

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%885.00.15.png" alt="截屏2020-11-16 下午5.00.15" style="zoom:50%;" />

  > **[举例]** 对IPv4数据报进行分片
  >
  > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%885.10.12.png" alt="截屏2020-11-16 下午5.10.12" style="zoom:50%;" />
  >
  > 假如经过某一个网络时还需要分片, 其中一个分片长度为800字节, 另一个分片长度为600字节
  >
  > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-16%20%E4%B8%8B%E5%8D%885.12.55.png" alt="截屏2020-11-16 下午5.12.55" style="zoom:50%;" />

- **生存时间TTL :** 

  占8比特, 最初以秒为单位, 最大生存周期为255秒;

  路由器转发IP数据报时, 将IP数据报首部中的该字段的值减去IP数据报在本路由器上所耗费的时间, 若不为0就转发, 否则就丢弃

  现在以**“跳数”**为单位, 路由器转发IP数据报时, 将IP数据报首部中的**该字段的值减1**, 若不为0就**转发**, 否则**就丢弃** 

  > **[举例]**生存时间TTL字段的作用 -防止IP数据报在网络中永久兜圈
  >
  > 人工配置了错误的R2路由条目
  >
  > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-17%20%E4%B8%8B%E5%8D%888.29.03.png" alt="截屏2020-11-17 下午8.29.03" style="zoom:50%;" />
  >
  > 

-  协议 : 

  占8比特, 指明IPv4数据报的数据部分是何种协议数据单元.

  常用的一些协议和相应的协议字段值如下  

    ![截屏2020-11-17 下午8.33.39](../img/%E6%88%AA%E5%B1%8F2020-11-17%20%E4%B8%8B%E5%8D%888.33.39.png)

- 首部检验和 : 

  **占16比特**, 用来检测首部在传输过程中是否出现差错. 比CRC检验码简单, 称为因特网检验和.

  ( IP数据报每经过一个路由器, 路由器都要重新计算首部检验和, 因为某些字段(生存时间、标志、片偏移等)的取值可能发生变化 )

  由于IP层本身**并不提供可靠传输的服务**, 并且计算首部校验和是一项耗时的操作, 因此在**IPv6中**, 路由器不再计算首部校验和, 从而更快的转发IP数据报

- 源IP地址和目的IP地址 :

  各占32比特, 用来填写**发送该IP数据报的源主机**的IP地址 和 **接收该IP数据报的目的主机**的IP地址

  

  > [2018年 题47]（7分）某公司网络如题47图所示。IP地址空间192.168.1.0/24被均分给销售部和技术部两个子网，并已分别为部分主机和路由器接口分配了IP地址，销售部子网的MTU=1500 B，技术部子网的MTU=800 B。
  >
  > ![截屏2020-11-17 下午8.44.02](../img/%E6%88%AA%E5%B1%8F2020-11-17%20%E4%B8%8B%E5%8D%888.44.02.png)
  >
  > 2)   假设主机192.168.1.1向主机192.168.1.208发送一个总长度为1500 B的IP分组，IP分组的头部长度为20 B，路由器在通过接口F1转发该IP分组时进行了分配。若分片时尽可能分为最大片，则一个最大IP分片封装数据的字节数是多少？至少需要分为几个分片？每个分片的片偏移量是多少？
  >
  > ![截屏2020-11-18 下午1.22.24](../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%881.22.24.png)
  >
  > 片偏移量必须是整数

  

  
  
  
  
  > ![截屏2020-11-18 下午1.27.18](../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%881.27.18.png)
>
  > 解析: 
>
  > (1)
>
  > ![截屏2020-11-18 下午1.35.17](../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%881.35.17.png)
  >
  > ![截屏2020-11-18 下午2.01.58](../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.01.58.png)
  >
  > (2)
  >
  > ![截屏2020-11-18 下午2.04.37](../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.04.37.png)

  

  






# 4.8 网际控制报文协议ICMP

- 为了更有效地转发IP数据报和提高交付成功的机会, 在网际层使用了网际控制报文协议ICMP(Internet Control Message Protocol)

- 主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**

- ICMP报文**被封装在IP数据报**中发送

- ICMP差错报告报文共有以下**五种:**

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.25.50.png" alt="截屏2020-11-18 下午2.25.50" style="zoom:50%;" />

  - **终点不可达:**

    当路由器或主机不能交付数据报时, 就向源点发送终点不可达报文, 具体可再根据ICMP的代码字段细分为:

    目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知等13种错误

    <img src="../../../%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.30.16.png" alt="截屏2020-11-18 下午2.30.16" style="zoom:50%;" />

  - **源点抑制:**

    当路由器或主机由于拥塞而丢弃数据报时, 就向源点发送源点抑制报文, 使源点知道应当把数据报的发送速率放慢

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.32.12.png" alt="截屏2020-11-18 下午2.32.12" style="zoom:50%;" />

  - **时间超过:**

    当路由器收到一个目的IP地址不是自己的IP数据报, 会将其生存时间TTL字段的值减1

    若结果不为0, 则将该IP数据报转发出去, 若结果为0, 除丢弃该IP数据报外, 好要向源点发送时间超过报文

    > 另外, 当终点在预先规定的时间内**不能**收到**一个数据报的全部数据报片时**, 就把已收到的数据报片都丢弃, 也会向源点发送时间超过报文

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.42.57.png" alt="截屏2020-11-18 下午2.42.57" style="zoom:50%;" />

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.43.24.png" alt="截屏2020-11-18 下午2.43.24" style="zoom:50%;" />

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%882.44.20.png" alt="截屏2020-11-18 下午2.44.20" style="zoom:50%;" />

    

    - **参数问题:**

      当路由器或目的主机收到IP数据报后, 根据其首部中的检验和字段发现首部在传输过程中出现了**误码**, 就丢弃该数据报, 并向源点发送**参数问题**报文

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%883.27.44.png" alt="截屏2020-11-18 下午3.27.44" style="zoom:50%;" />

      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%883.27.53.png" alt="截屏2020-11-18 下午3.27.53" style="zoom:50%;" />

    

    - **改变路由(重定向):**
    
      路由器把改变路由报文发送给主机, 让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)
    
      <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%883.32.48.png" alt="截屏2020-11-18 下午3.32.48" style="zoom:50%;" />
    
  - 对ICMP差错报告报文不再发送ICMP差错报告报文
  
  - 对第一个分片的数据报片的**所有后续数据报片**都不发送ICMP差错报告报文
  
  - 对具有多播地址的数据报都不发送ICMP差错报告报文
  
  - 对具有特殊地址( 127.0.0.0 或 0.0.0.0 )的数据报不发送ICMP差错报告报文



> [2010年题36]若路由器R因为拥塞丢弃IP分组，则此时R可向发出该IP分组的源主机发送的ICMP报文类型是 
>
> A．路由重定向		 B．目的不可达		 C．源点抑制 		D．超时 
>
> 【答案】C

- 常用的ICMP**询问报文**有以下两种:

  - **回送**请求和回答

    ICMP**回送请求**报文是由主机或路由器向一个特定的目的主机发出的询问

    收到此报文的主机必须给源主机或路由器发送ICMP**回送回答**报文

    这种询问报文用来**测试目的站是否可达**及**了解其有关状态**

  - **时间戳**请求和回答

    ICMP时间戳请求报文是请求某个主机或路由器回答当前的日期和时间

    在ICMP时间戳回答报文中有一个32位的字段, 其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒

    这种询问报文用来进行**时钟同步**和**测量时间**

- ICMP应用举例

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%883.50.22.png" alt="截屏2020-11-18 下午3.50.22" style="zoom:50%;" />

  - **分组网间探测PING**

    用来测试主机或路由器间的连通性

    应用层直接使用网际层的ICMP(没有通过运输层的TCP或UDP)

    使用ICMP回送请求和回答报文

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%883.54.55.png" alt="截屏2020-11-18 下午3.54.55" style="zoom:50%;" />

  - **跟踪路由trcaeroute**

    用来测试IP数据报从源主机到达目的主机要经过哪些路由器

    - Windows版本
      - tracert命令
      - **应用层**直接使用网际层ICMP
      - 使用了ICMP**回送请求和回答报文**以及**差错报告报文**
    - **Unix版本**
      - traceroute命令
      - 在**运输层**使用UDP协议
      - 仅使用ICMP**差错报告报文**

    路由跟踪实现原理:使用**生存时间TTL控制下一跳的距离**:

    1.首先将TTL设置为1:

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%884.40.16.png" alt="截屏2020-11-18 下午4.40.16" style="zoom:50%;" />

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%884.40.58.png" alt="截屏2020-11-18 下午4.40.58" style="zoom:50%;" />

    2.下一步将生存时间TTL的值设置为2:

    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%884.41.59.png" alt="截屏2020-11-18 下午4.41.59" style="zoom:50%;" />

		<img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%884.43.15.png" alt="截屏2020-11-18 下午4.43.15" style="zoom:50%;" />

    ​    3.第三次将生存时间TTL设置为3: 封装有**ICMP回送请求的回答报文**就是最后一站了
    
    <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%884.46.32.png" alt="截屏2020-11-18 下午4.46.32" style="zoom:50%;" />

​    

​    

# 4.9 虚拟专用网VPN 与 网络地址转换NAT

-  **虚拟专用网VPN(Virtual Private NetWork)**

  利用**公用的因特网**作为本机构各专用网之间的通信载体, 这样的专用网又称为**虚拟专用网**.

  由于IPv4地址的紧缺, 一个机构能够申请到的IPv4地址数量往往远小于本机构所拥有的主机数量, 因此, 虚拟专用网中的各主机所分配的地址应该是**本机构可自由分配的专用地址**, 而**不是**需要申请的, 在因特网上使用的**公有地址**

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%887.49.20.png" alt="截屏2020-11-18 下午7.49.20" style="zoom:50%;" />

  > 我们可以在因特网数字分配机构IANA的官方网站, 查看IPv4地址空间中特殊的分配方案
  >
  > 这三个地址块中的地址就是无需申请的、可自由分配的专用地址
  >
  > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%887.54.58.png" alt="截屏2020-11-18 下午7.54.58" style="zoom:50%;" />
  >
  > 专用 (私有) 地址:
  >
  > <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.18.40.png" alt="截屏2020-11-18 下午8.18.40" style="zoom:50%;" />
  >
  > 10.0.0.0~10.255.255.255( 10/8 地址块 )
  >
  > 172.16.0.0~172.31.255.255( 172.16/12 地址块 )
  >
  > 192.168.0.0~192.168.255.255( 192.168/16 地址块 )

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.01.34.png" alt="截屏2020-11-18 下午8.01.34" style="zoom:50%;" />

  如下图所示, 统一机构内**不同部门的内部网络**所构成的虚拟专用网VPN又称为**内联网VPN**

  有时候一个机构的VPN需要有**某些外部机构**( 通常就是合作伙伴 )参加进来. 这样的VPN就称为**外联网VPN.**

  在**外地工作的员工需要访问公司内部的专用网络时**, 只要在任何地点接入到因特网, 运行主流在员工PC中的VPN软件, 在员工的PC和公司的主机之间建立VPN隧道, 即可访问专用网络中的资源, 这种VPN称为**远程接入VPN**

  ![截屏2020-11-18 下午8.02.54](../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.02.54.png)

​    

- **网络地址转换NAT(Network Address Translation)**

  虽然因特网采用了无分类编址方式来缓解IPv4地址空间耗尽的速度, 但由于因特网用户数目的激增, 特别是大量**小型办公室网络**和家庭网络接入因特网的需求不断增加, IPv4地址空间即将面临耗尽的危险仍然没有被解除

  1994年提出了一种网络地址转换NAT的方法再次缓解了IPv4地址空间即将耗尽的问题.

  NAT能使大量使用**内部专用网地址**的**专用网络用户**共享少量**外部全球地址**来访问因特网上的主机和资源

  私有地址主机**发送数据报时:**

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.20.30.png" alt="截屏2020-11-18 下午8.20.30" style="zoom:50%;" />

  全球地址主机发送数据报时:

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.22.24.png" alt="截屏2020-11-18 下午8.22.24" style="zoom:50%;" />
  
   两台私有地址主机都要发送IP数据报时, 产生两条对应的记录, 如下图所示:
  
  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.26.39.png" alt="截屏2020-11-18 下午8.26.39" style="zoom:50%;" />
  
  实际上:
  
  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.28.24.png" alt="截屏2020-11-18 下午8.28.24" style="zoom:50%;" />
  
- 另一个问题: 

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.30.17.png" alt="截屏2020-11-18 下午8.30.17" style="zoom:50%;" />

  <img src="../img/%E6%88%AA%E5%B1%8F2020-11-18%20%E4%B8%8B%E5%8D%888.32.22.png" alt="截屏2020-11-18 下午8.32.22" style="zoom:50%;" />





​    

​    

